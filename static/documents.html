<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="/styles.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <script>


        $(document).ready(function () {
            refreshList();

            $("#saveOrAdd").click(function () { // add or update
                let titleVal = $("input[name=title]").val();
                console.log($("input[name=file]").prop('files'));
                let file = $("input[name=file]").prop('files')[0];
                let filenameVal = file.name; // not used by me, but you can use it if you like, add 'filename' column to database
                let mimeTypeVal = file.type;
                // https://javascript.info/file  (about FileReader, see readAsDataURL )
                let reader = new FileReader();
                reader.onload = function () {
                    // console.log(reader.result); // careful, may print out hundreds of lines of binary
                    // magically "reader.result" hold the contents of the selected file, btoa() encodes it to base64
                    docObj = { title: titleVal, mimeType: mimeTypeVal, data: btoa(reader.result) }
                    $.ajax({ // FIXME: escape special characters using urlencode
                        url: "/api/documents",
                        type: "POST",
                        dataType: "json",
                        data: docObj,
                        error: function (jqxhr, status, errorThrown) {
                            alert("AJAX error: " + jqxhr.responseText);
                        }
                    }).done(function () {
                        alert("upload successful");
                        refreshList();
                    });
                };
                reader.onerror = function () {
                    console.log(reader.error);
                    alert(reader.error);
                };
                //reader.readAsDataURL(file); // read file and trigger one of the above handlers
                reader.readAsBinaryString(file);

                return;
            });
        });

        function refreshList() {
            console.log("Refreshing");
            $.ajax({ // future: headers for authentication, url parameters for sorting, etc.
                url: "/api/documents",
                type: "GET",
                dataType: "json",
                error: function (jqxhr, status, errorThrown) {
                    alert("AJAX error: " + jqxhr.responseText);
                }
            }).done(function (list) {
                var result = '<tr><th>#</th><th>Title</th><th>Data</th><th>Mime type</th></tr>';
                for (var i = 0; i < list.length; i++) {
                    var item = list[i];
                    result += '<tr>';
                    result += '<td>' + item.id + '</td>';
                    result += '<td>' + item.title + '</td>';
                    result += '<td><a href="/api/documents/' + item.id + '">click</a></td>';
                    result += '<td>' + item.mimeType + '</td>';
                    result += '</tr>' + "\n";
                }
                $("#listTable").html(result);
            });
        }

    </script>
</head>

<body>
    <div id="centerContent">
        <div id="listPane">
            <button id="showAddItem">Add item</button>
            <table id="listTable" border="1"></table>
        </div>
        <div id="viewAddEditPane">
            title: <input type="text" name="title"><br>
            File: <input type="file" name="file"><br>
            <button id="saveOrAdd">Upload (add)</button>
        </div>
    </div>
</body>

</html>